{% extends "base.html" %}

{% block title %}Event Details - {{ event.name }}{% endblock %}

{% block content %}
<h1 class="text-3xl font-bold mb-4 text-gray-800">{{ event.name }}</h1>
<p class="text-gray-600 text-lg mb-2"><strong>Date:</strong> {{ event.date.strftime('%Y-%m-%d %H:%M') }}</p>
<p class="text-gray-600 text-lg mb-4"><strong>Location:</strong> {{ event.location }}</p>
<p class="text-gray-700 mb-6">{{ event.description }}</p>

<div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
    <div class="bg-white p-6 rounded-lg shadow-md">
        <h2 class="text-xl font-semibold mb-4 text-gray-800">Event Management</h2>
        <div class="space-y-3">
            <a href="{{ url_for('event_qr_code', event_id=event.id) }}"
               class="block bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded text-center transition duration-200">
                View Event Registration QR
            </a>
            <a href="{{ url_for('checkin_scanner', event_id=event.id) }}"
               class="block bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded text-center transition duration-200">
                Open Check-in Scanner
            </a>
            <a href="{{ url_for('download_attendees', event_id=event.id) }}"
               class="block bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded text-center transition duration-200">
                Download Attendee List (CSV)
            </a>
             <form action="{{ url_for('delete_event', event_id=event.id) }}" method="POST" onsubmit="return confirm('Are you sure you want to delete this event and all its participants/attendance data?');" class="block">
                <button type="submit"
                        class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded text-center transition duration-200">
                    Delete Event
                </button>
            </form>
        </div>
    </div>
    <div class="bg-white p-6 rounded-lg shadow-md">
        <h2 class="text-xl font-semibold mb-4 text-gray-800">Attendance Overview</h2>
        <p class="text-gray-700 text-lg">
            Registered Participants: <span class="font-bold">{{ participants|length }}</span>
        </p>
        <p class="text-gray-700 text-lg mb-4">
            Checked-in Attendees: <span class="font-bold" id="live-attendance-count">{{ attendance_count }}</span>
        </p>
        <button id="refreshAttendance" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded text-sm">Refresh Live Count</button>
    </div>
</div>

<h2 class="text-2xl font-bold mb-4 text-gray-800">Registered Participants</h2>
{% if participants %}
<div class="bg-white shadow-md rounded-lg overflow-hidden">
    <table class="min-w-full leading-normal">
        <thead>
            <tr class="bg-gray-200 text-gray-600 uppercase text-sm leading-normal">
                <th class="py-3 px-6 text-left">Name</th>
                <th class="py-3 px-6 text-left">Student ID</th>
                <th class="py-3 px-6 text-left">Email</th>
                <th class="py-3 px-6 text-left">Registration Date</th>
                <th class="py-3 px-6 text-center">Checked In</th>
            </tr>
        </thead>
        <tbody class="text-gray-700 text-sm">
            {% for participant in participants %}
            <tr class="border-b border-gray-200 hover:bg-gray-100">
                <td class="py-3 px-6 text-left">{{ participant.name }}</td>
                <td class="py-3 px-6 text-left">{{ participant.student_id }}</td>
                <td class="py-3 px-6 text-left">{{ participant.email }}</td>
                <td class="py-3 px-6 text-left">{{ participant.registration_date.strftime('%Y-%m-%d %H:%M') }}</td>
                <td class="py-3 px-6 text-center">
                    {% if participant.attendance %}
                        <span class="text-green-600 font-semibold">Yes ({{ participant.attendance.check_in_time.strftime('%H:%M') }})</span>
                    {% else %}
                        <span class="text-red-600">No</span>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% else %}
<p class="text-gray-700">No participants registered for this event yet.</p>
{% endif %}

<script>
    document.getElementById('refreshAttendance').addEventListener('click', function() {
        const eventId = "{{ event.id }}";
        fetch(`/admin/event/${eventId}/live_attendance`)
            .then(response => response.json())
            .then(data => {
                document.getElementById('live-attendance-count').textContent = data.attendance_count;
                alert('Attendance count refreshed!');
            })
            .catch(error => console.error('Error fetching live attendance:', error));
    });
</script>
{% endblock %}
